# 零、本篇前言

说实话，我很纠结是先介绍瓦片的二进制数据文件结构，还是先介绍这两个重要的表。思前想后，我决定还是先介绍这两个数据表。

因为这两个表不先给读者灌输，那么介绍到瓦片的二进制数据文件结构时，就满嘴“晦涩难懂”啦。

## 数据与模型

上文介绍到，瓦片的三维模型实际上是由gltf承担起来的（作为glb格式嵌入到瓦片二进制文件中），那么，除了模型数据，肯定模型自己本身也有属性数据的。

就比如，门有长宽高、密度、生产日期等信息，楼栋模型有建筑面积、楼层数等信息。

所以，“属性数据” 和 “模型” 是如何产生联系的呢？

![image-20200628030008522](attachments/image-20200628030008522.png)

早在我的博客《[聊聊GIS数据的四个分层与GIS服务](http://www.baidu.com/link?url=Hl4K-e8jXLObJOoopbin3YZ3Qmd5m5WMRbgw9zUuCc9FMKA-th4cQkqDc1JTcTUgQLvnwJIzgpcJtBwBUVDGUK)》中有提及，只需把模型的几何数据作为一个属性，写入属性数据中，即把属性数据和几何数据并列，就可以了。

但是，在3dTiles中，模型数据是以glb的形式嵌入在瓦片文件中的（点云直接就写xyz和颜色信息了），模糊了二维中“要素”的概念，而且gltf规范看起来并没有所谓的“要素”的概念，仅仅是对GPU友好的vertex、normal、texture等信息。

如何让gltf模型的每一个模型，甚至每一个三角面，甚至每一个顶点打上“我属于哪个模型”的印记呢？我们本篇稍稍晚一些介绍。

再回忆一个重要的 3dTiles 理念：

> 3dTiles 规范本身不包含模型数据的定义，它仅仅记录模型变成瓦片后的空间组织关系、模型与其属性数据之间的关系。

所以，3dTiles 规范在瓦片二进制数据文件中，使用了两个重要的表来记录这种 ”模型与属性“ 的联系：

- FeatureTable（要素表）
- BatchTable（批量表）

![image-20200628025332979](attachments/image-20200628025332979.png)

这两个表既然是二进制的数据，尽管它名字里带“表”，但是却不是二维表格，它更多的是一些 *键值* 信息。

每一种瓦片文件里这两个表的具体内容都不一样，但是大致功能是差不多的。

请牢记：

**要素表记录的是整个瓦片的公共数据，批量表更专注于记录每个模型（或每个三维要素）自己的信息。**

**两个表都作为二进制格式存在瓦片文件的前部。**

# 一、记录渲染相关的数据：FeatureTable，要素表

在 b3dm 瓦片中，要素表记录这个批量模型瓦片中模型的个数，这个模型单体在人类逻辑上不可再分。

（在房屋级别来看，房子并不是单体，构造它的门、门把、窗户、屋顶、墙等才是模型单体；但是在模型壳子的普通表面建模数据中，房子就是一个简单的模型）

要素表还可以记录当前瓦片的中心坐标，以便gltf使用相对坐标，压缩顶点坐标数字的数据量。

官方给的定义是：

> 要素表记录的是与渲染有关的数据。

直球！听不懂！

我来“翻译”一下好了：

> 要素表，记录的是整个瓦片渲染相关的数据，而不是渲染所需的数据（因为由gltf承包了）。渲染相关，即有多少个模型，坐标是相对的话相对于哪个中心，如果是点云的话颜色信息是什么以及坐标如何等

我们以pnts（点云瓦片）举例，它的要素表允许有两大类数据（看不懂没关系，之后的博客还会继续介绍四种瓦片文件的结构）：

- 点属性

| 属性名             | 数据类型                  | 描述                                   | 是否必须               |
| ------------------ | ------------------------- | -------------------------------------- | ---------------------- |
| POSITION           | float32 * 3               | 直角坐标的点                           | 是，除非下面的属性存在 |
| POSITION_QUANTIZED | uint16 * 3                | 量化的直角坐标点                       | 是，除非上面的属性存在 |
| RGBA               | uint8 * 4                 | 四通道颜色                             |                        |
| RGB                | uint8 * 3                 | RGB颜色                                | /                      |
| RGB565             | uint16                    | 有损压缩颜色，红5绿6蓝5，即65536种颜色 | /                      |
| NORMAL             | float32 *3                | 法线                                   | /                      |
| NORMAL_OCT16P      | uint8 * 2                 | 点的法线，10进制单位向量，有16bit精度  | /                      |
| BATCH_ID           | uint8/uint16(默认)/uint32 | 从BatchTable种检索元数据的id           | /                      |

- 全局属性

| 属性名                  | 数据类型    | 描述                                                         | 是否必须                         |
| ----------------------- | ----------- | ------------------------------------------------------------ | -------------------------------- |
| POINTS_LENGTH           | uint32      | 瓦片中点的数量。所有的点属性的长度必须与这个一样。           | 是                               |
| RTC_CENTER              | float32 * 3 | 如果所有点是相对于某个点定位的，那么这个属性就是这个相对的点的坐标。 | /                                |
| QUANTIZED_VOLUME_OFFSET | float32 * 3 | 量化偏移值（不知道是什么）                                   | 与下面的属性必须同时存在         |
| QUANTIZED_VOLUME_SCALE  | float32 * 3 | 量化缩放比例（不知道是什么）                                 | 与上面的属性必须同时存在         |
| CONSTANT_RGBA           | uint8 * 4   | 为所有点定义同一个颜色                                       | /                                |
| BATCH_LENGTH            | uint32      | BATCH_ID的个数                                               | 与点属性中的BATCH_ID必须同时存在 |

简略一瞥，可以看出点云因为没有使用gltf模型（也没必要），把点云要渲染到屏幕上所需的坐标、法线、颜色等信息写在了要素表中。

如果还是不能理解何为“渲染相关”，那么请阅读后续四种瓦片文件格式的详细介绍，相信你会有所收获——有可能是我表达比较菜。

要说明一个“业界黑话”：

> 在一个瓦片中，一个三维要素（GIS中的通常叫法）= 一个模型（图形学、工业建模叫法） = 一个BATCH（3dtiles叫法）

所以，为什么另外一张表叫 `BatchTable`，而且它记录的是属性数据，我想就很容易想明白了。接下来，介绍记录属性数据的批量表：

## 要素表的结构：JSON描述信息+批量表数据本体



# 二、记录属性数据：BatchTable，批量表

如果把批量表删除，那么3dTiles数据还能正常渲染。

是的，批量表就是所谓的模型属性表，批量表中每个属性数组的个数，就等于模型的个数，因为有多少个模型就对应多少个属性嘛！

（嘿嘿，其实也有例外的情况，我们到后续聊3dtiles数据规范的扩展能力时，再把这个坑填上，不然怎么说3dtiles很灵keng活die呢）

批量表相对比较自由，只要能与模型对得上号，想写啥就写啥。

## 批量表的结构：JSON描述信息+批量表数据本体



关于两个表的更深一级关系，要等到具体瓦片的介绍篇章，请翻阅后面的篇章。