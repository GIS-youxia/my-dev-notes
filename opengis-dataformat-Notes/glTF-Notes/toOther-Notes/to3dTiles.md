> 前提：无动画、骨骼、蒙皮。
>
> 若存在 draco 压缩则需要先解压

# 综合考虑

node：mesh的情况

mesh：primitive的情况

primitive中顶点的情况

# 1. node：mesh：primitive = 1：1：1

这种情况，只需判别 primitive 中顶点属性的 size。

由于 primitive 之间的材质是不相同的，所以合并 primitive 的难度稍大。

> 思路，遍历 node>mesh>primitive，若材质相同，则归为一组，记录其 node 的转换矩阵，合并到一个 primitive，构造新的 mesh 和 node。
>
> 顶点属性只需依次往后加序号即可。

最操蛋的就是两种材质十分类似的情况，这种需要人工视觉判别，然后人为将两种材质视作一种（一般这种材质没有纹理贴图，有纹理贴图那合并个球球），可取材质对象的各种参数平均，然后合并 primitive。

# 2. node：mesh = 1：1，mesh：primitive = 1：N

这个情况与上面类似处理。mesh 更像是一堆不同材质的图元的整合体，可作为一个独立的模型，拆就是。

# 3. node：mesh = N：1，mesh：primitive = any

这种情况属于模型复用顶点数据。和1、2情况类似，在处理单元上标记好转换矩阵即可。

# 4. *拆 primitive

uv 和贴图是一个问题。

拆分图元的情况可能出现：

## 4.1. primitive 过大

顶点属性的总体积 + 纹理贴图的总体积 > 预设值时，primitive 过大。

切开 primitive 的顶点属性比较容易，根据 uv 切开纹理贴图有一定计算困难。

> 好像没别的原因？

# 5. *并 material

uv 是一个问题，纹理贴图重排是很难的

合并 material 的情况较少，仅出现在 primitive 的材质不同的情况。

# 6. 创建原则

drawcall 尽可能少（也就是单个 gltf 的复用 primitive 总量不超过一定阈值，单个通常是 2000 drawcall）的前提下，保证 node/mesh/primitive 的还原度。还原度是什么？

即一个 node/mesh/primitive 代表的真实物体，具体取决于你的分层细粒度。

因为 node/mesh 均拥有 `extras` 和 `extensions`，且 node 是对 mesh 中顶点数据的复用，通常分层细粒度到 node，而不是最细的 primitive。

## 6.1. 一比一原则

保持 node：mesh：primitive = 1：1：1 为佳。

### 什么时候不是一比一

因为专属于 3dTiles 的转换，所以不考虑顶点属性复用，即不考虑 node：mesh = N：1

那就剩下 mesh：primitive != 1：1 了，这种情况即一个物体有多个材质构成，每个材质分配一个 primitive。

## 6.2. 瓦片原则

### ① b3dm

控制 b3dm 的 size，控制 b3dm 内 gltf 的 drawcall，至少不要超过 1000（经验值）。

经验值，10M 带宽的网络（客户机），每个瓦片控制在 [0.5~1] MB（取决于纹理：顶点属性）。

### ② i3dm

控制 drawcall 尽可能少于 1000，实际上 i3dm 的 gltf 可能会很小。

i3dm 和 b3dm 最大的区别是，i3dm 的 gltf 的总体积可以稍大。

i3dm 的总体积可以保持在 1M 左右，小可以很小，因为一般 i3dm 请求的次数较少。

### ③ cmpt

不推荐使用，只合并体积，不减小 drawcall 的简单办法。

## 6.3. 原结构优先原则

若 gltf 本身就有树结构，保持其树结构为佳。

若较为扁平化，则需要进入树结构重组，计算量比较大。

主要是 OBB 重算（可能）、空间八叉树分组（或使用 KD 树也不错，因地制宜，若模型本身z：x或z：y比较小，说明xy范围大，可不必使用八叉树，用四叉树就可以了）

## 6.4. 合并原则

### ① drawcall 减少

能合并就合并，同几何误差的瓦片个数 x 每个瓦片的 drawcall 决定某个视角的性能，总瓦片 x 每个瓦片的drawcall 决定全模型的性能。

### ② 控制瓦片数

在减少 drawcall 的前提下，尽可能把数据塞到同一个瓦片中，减少的是网络请求。

# 7. 妥协策略

因技术不到位可以采取如下方法：

- 使用 cmpt 合并小文件瓦片（但并不能提高绘制速度）

# 对照关系

- draco：压缩数据，同体积更多数据被传输，提升的是 **网络方面**，降低了传输时间
- 合并 primitive：减少 drawcall，提升的是 **性能指标**
- 使用webp或压缩纹理：提升的是 **网络方面**，降低了传输时间
- 不要弄太小的瓦片：提升的是 **网络方面**，减少网络请求
- 不要弄太大的瓦片：提升的是 **网络方面**，降低了传输时间
- gzip：提升的是 **网络方面**，降低了 json 数据传输时间
- 嵌套瓦片数据集策略：提升的是 **网络方面**，使用 WebWorker 降低了传输时间
- *使用 3dTiles 新扩展：待定*
- 使用合理的树结构：提升的是 **性能指标**，提高了检索速度
- 使用合理的几何误差：提升的是 **性能指标**，提高了瓦片 LOD 过滤能力（同几何误差的瓦片尽可能少，osgb 就是个反例，瓦片多且几何误差一样，虽然瓦片本身比较小）